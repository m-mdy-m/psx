# DevOps Templates and Configurations

# Docker
docker:
  nodejs:
    dockerfile: |
      # Build stage
      FROM node:18-alpine AS builder

      WORKDIR /app

      # Copy package files
      COPY package*.json ./

      # Install dependencies
      RUN npm ci --only=production

      # Copy source code
      COPY . .

      # Build application
      RUN npm run build

      # Production stage
      FROM node:18-alpine

      WORKDIR /app

      # Copy from builder
      COPY --from=builder /app/dist ./dist
      COPY --from=builder /app/node_modules ./node_modules
      COPY --from=builder /app/package.json ./

      # Create non-root user
      RUN addgroup -g 1001 -S nodejs && \
          adduser -S nodejs -u 1001

      USER nodejs

      EXPOSE 3000

      CMD ["node", "dist/index.js"]

    dockerignore: |
      # Dependencies
      node_modules/
      npm-debug.log*
      yarn-error.log*

      # Build
      dist/
      build/
      .next/

      # Environment
      .env*

      # Git
      .git/
      .gitignore

      # IDE
      .vscode/
      .idea/

      # Testing
      coverage/
      .nyc_output/

      # Misc
      *.md
      .DS_Store

  go:
    dockerfile: |
      # Build stage
      FROM golang:1.21-alpine AS builder

      WORKDIR /app

      # Copy go mod files
      COPY go.mod go.sum ./
      RUN go mod download

      # Copy source code
      COPY . .

      # Build
      RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

      # Production stage
      FROM alpine:latest

      RUN apk --no-cache add ca-certificates

      WORKDIR /root/

      # Copy binary from builder
      COPY --from=builder /app/main .

      EXPOSE 8080

      CMD ["./main"]

    dockerignore: |
      # Build
      build/
      *.exe
      *.test
      *.out

      # Dependencies
      vendor/

      # Git
      .git/
      .gitignore

      # IDE
      .vscode/
      .idea/

      # Testing
      coverage.txt
      coverage.html

      # Misc
      *.md
      .DS_Store

# Docker Compose
docker_compose:
  basic: |
    version: '3.8'

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=production
        restart: unless-stopped

  with_db: |
    version: '3.8'

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=production
          - DATABASE_URL=postgresql://user:password@db:5432/mydb
        depends_on:
          - db
        restart: unless-stopped

      db:
        image: postgres:15-alpine
        environment:
          - POSTGRES_USER=user
          - POSTGRES_PASSWORD=password
          - POSTGRES_DB=mydb
        volumes:
          - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped

    volumes:
      postgres_data:

# GitHub Actions
github_actions:
  nodejs_ci: |
    name: CI

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main, develop ]

    jobs:
      test:
        runs-on: ubuntu-latest

        strategy:
          matrix:
            node-version: [18.x, 20.x]

        steps:
        - uses: actions/checkout@v4

        - name: Use Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@v4
          with:
            node-version: ${{ matrix.node-version }}
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Lint
          run: npm run lint

        - name: Test
          run: npm test

        - name: Build
          run: npm run build

  go_ci: |
    name: CI

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main, develop ]

    jobs:
      test:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: '1.21'

        - name: Install dependencies
          run: go mod download

        - name: Lint
          uses: golangci/golangci-lint-action@v3
          with:
            version: latest

        - name: Test
          run: go test -v -race -coverprofile=coverage.out ./...

        - name: Build
          run: go build -v ./...

  docker_build: |
    name: Docker Build

    on:
      push:
        branches: [ main ]
        tags: [ 'v*.*.*' ]

    jobs:
      build:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: {{docker_image}}

        - name: Build and push
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=gha
            cache-to: type=gha,mode=max
