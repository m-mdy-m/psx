# DevOps Templates and Configurations

# Docker
docker:
  nodejs:
    dockerfile: |
      # Build stage
      FROM node:18-alpine AS builder

      WORKDIR /app

      # Copy package files
      COPY package*.json ./

      # Install dependencies
      RUN npm ci --only=production

      # Copy source code
      COPY . .

      # Build application
      RUN npm run build

      # Production stage
      FROM node:18-alpine

      WORKDIR /app

      # Copy from builder
      COPY --from=builder /app/dist ./dist
      COPY --from=builder /app/node_modules ./node_modules
      COPY --from=builder /app/package.json ./

      # Create non-root user
      RUN addgroup -g 1001 -S nodejs && \
          adduser -S nodejs -u 1001

      USER nodejs

      EXPOSE 3000

      CMD ["node", "dist/index.js"]

    dockerignore: |
      # Dependencies
      node_modules/
      npm-debug.log*
      yarn-error.log*

      # Build
      dist/
      build/
      .next/

      # Environment
      .env*

      # Git
      .git/
      .gitignore

      # IDE
      .vscode/
      .idea/

      # Testing
      coverage/
      .nyc_output/

      # Misc
      *.md
      .DS_Store

  go:
    dockerfile: |
      # Build stage
      FROM golang:1.21-alpine AS builder

      WORKDIR /app

      # Copy go mod files
      COPY go.mod go.sum ./
      RUN go mod download

      # Copy source code
      COPY . .

      # Build
      RUN CGO_ENABLED=0 GOOS=linux go build -a -installsuffix cgo -o main .

      # Production stage
      FROM alpine:latest

      RUN apk --no-cache add ca-certificates

      WORKDIR /root/

      # Copy binary from builder
      COPY --from=builder /app/main .

      EXPOSE 8080

      CMD ["./main"]

    dockerignore: |
      # Build
      build/
      *.exe
      *.test
      *.out

      # Dependencies
      vendor/

      # Git
      .git/
      .gitignore

      # IDE
      .vscode/
      .idea/

      # Testing
      coverage.txt
      coverage.html

      # Misc
      *.md
      .DS_Store

# Docker Compose
docker_compose:
  basic: |
    version: '3.8'

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=production
        restart: unless-stopped

  with_db: |
    version: '3.8'

    services:
      app:
        build:
          context: .
          dockerfile: Dockerfile
        ports:
          - "3000:3000"
        environment:
          - NODE_ENV=production
          - DATABASE_URL=postgresql://user:password@db:5432/mydb
        depends_on:
          - db
        restart: unless-stopped

      db:
        image: postgres:15-alpine
        environment:
          - POSTGRES_USER=user
          - POSTGRES_PASSWORD=password
          - POSTGRES_DB=mydb
        volumes:
          - postgres_data:/var/lib/postgresql/data
        restart: unless-stopped

    volumes:
      postgres_data:

# Kubernetes
kubernetes:
  deployment: |
    apiVersion: apps/v1
    kind: Deployment
    metadata:
      name: {{project_name}}
      labels:
        app: {{project_name}}
    spec:
      replicas: 3
      selector:
        matchLabels:
          app: {{project_name}}
      template:
        metadata:
          labels:
            app: {{project_name}}
        spec:
          containers:
          - name: {{project_name}}
            image: {{project_name}}:latest
            ports:
            - containerPort: 8080
            env:
            - name: ENV
              value: "production"
            resources:
              limits:
                cpu: "500m"
                memory: "512Mi"
              requests:
                cpu: "250m"
                memory: "256Mi"
            livenessProbe:
              httpGet:
                path: /health
                port: 8080
              initialDelaySeconds: 30
              periodSeconds: 10
            readinessProbe:
              httpGet:
                path: /ready
                port: 8080
              initialDelaySeconds: 5
              periodSeconds: 5

  service: |
    apiVersion: v1
    kind: Service
    metadata:
      name: {{project_name}}
    spec:
      selector:
        app: {{project_name}}
      ports:
        - protocol: TCP
          port: 80
          targetPort: 8080
      type: LoadBalancer

  ingress: |
    apiVersion: networking.k8s.io/v1
    kind: Ingress
    metadata:
      name: {{project_name}}
      annotations:
        kubernetes.io/ingress.class: nginx
        cert-manager.io/cluster-issuer: letsencrypt-prod
    spec:
      tls:
      - hosts:
        - {{domain}}
        secretName: {{project_name}}-tls
      rules:
      - host: {{domain}}
        http:
          paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: {{project_name}}
                port:
                  number: 80

# Nginx
nginx:
  static: |
    server {
        listen 80;
        server_name {{domain}};
        root /usr/share/nginx/html;
        index index.html;

        # Compression
        gzip on;
        gzip_types text/plain text/css application/json application/javascript text/xml application/xml application/xml+rss text/javascript;

        location / {
            try_files $uri $uri/ /index.html;
        }

        # Cache static assets
        location ~* \.(jpg|jpeg|png|gif|ico|css|js|svg|woff|woff2)$ {
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }

  reverse_proxy: |
    upstream backend {
        server app:8080;
    }

    server {
        listen 80;
        server_name {{domain}};

        # Proxy to backend
        location / {
            proxy_pass http://backend;
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection 'upgrade';
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_cache_bypass $http_upgrade;
        }

        # Health check
        location /health {
            access_log off;
            proxy_pass http://backend/health;
        }
    }

# GitHub Actions
github_actions:
  nodejs_ci: |
    name: CI

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main, develop ]

    jobs:
      test:
        runs-on: ubuntu-latest

        strategy:
          matrix:
            node-version: [18.x, 20.x]

        steps:
        - uses: actions/checkout@v4

        - name: Use Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@v4
          with:
            node-version: ${{ matrix.node-version }}
            cache: 'npm'

        - name: Install dependencies
          run: npm ci

        - name: Lint
          run: npm run lint

        - name: Test
          run: npm test

        - name: Build
          run: npm run build

  go_ci: |
    name: CI

    on:
      push:
        branches: [ main, develop ]
      pull_request:
        branches: [ main, develop ]

    jobs:
      test:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - name: Set up Go
          uses: actions/setup-go@v5
          with:
            go-version: '1.21'

        - name: Install dependencies
          run: go mod download

        - name: Lint
          uses: golangci/golangci-lint-action@v3
          with:
            version: latest

        - name: Test
          run: go test -v -race -coverprofile=coverage.out ./...

        - name: Build
          run: go build -v ./...

  docker_build: |
    name: Docker Build

    on:
      push:
        branches: [ main ]
        tags: [ 'v*.*.*' ]

    jobs:
      build:
        runs-on: ubuntu-latest

        steps:
        - uses: actions/checkout@v4

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Login to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}

        - name: Extract metadata
          id: meta
          uses: docker/metadata-action@v5
          with:
            images: {{docker_image}}

        - name: Build and push
          uses: docker/build-push-action@v5
          with:
            context: .
            push: true
            tags: ${{ steps.meta.outputs.tags }}
            labels: ${{ steps.meta.outputs.labels }}
            cache-from: type=gha
            cache-to: type=gha,mode=max

# Renovate
renovate:
  config: |
    {
      "$schema": "https://docs.renovatebot.com/renovate-schema.json",
      "extends": [
        "config:base"
      ],
      "packageRules": [
        {
          "matchUpdateTypes": ["minor", "patch"],
          "automerge": true
        }
      ],
      "schedule": [
        "before 5am on monday"
      ],
      "labels": ["dependencies"]
    }

# Dependabot
dependabot:
  config: |
    version: 2
    updates:
      # GitHub Actions
      - package-ecosystem: "github-actions"
        directory: "/"
        schedule:
          interval: "weekly"
        labels:
          - "dependencies"
          - "github-actions"

      # Docker
      - package-ecosystem: "docker"
        directory: "/"
        schedule:
          interval: "weekly"
        labels:
          - "dependencies"
          - "docker"

  nodejs: |
    version: 2
    updates:
      - package-ecosystem: "npm"
        directory: "/"
        schedule:
          interval: "weekly"
        labels:
          - "dependencies"
          - "npm"
        versioning-strategy: increase

  go: |
    version: 2
    updates:
      - package-ecosystem: "gomod"
        directory: "/"
        schedule:
          interval: "weekly"
        labels:
          - "dependencies"
          - "go"
